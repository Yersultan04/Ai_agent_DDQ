{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/lib/db/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/app/api/projects/%5BprojectId%5D/export/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/db/prisma\";\n\nexport const runtime = \"nodejs\";\n\nfunction csvEscape(v: unknown) {\n  const s = String(v ?? \"\");\n  if (/[,\"\\n]/.test(s)) return `\"${s.replace(/\"/g, '\"\"')}\"`;\n  return s;\n}\n\nfunction computeStats(questions: Array<any>) {\n  const totalQuestions = questions.length;\n  const answeredQuestions = questions.filter((q) => (q.answers?.[0]?.text ?? \"\").trim().length > 0).length;\n  const approvedAnswers = questions.filter((q) => q.answers?.[0]?.status === \"APPROVED\").length;\n  const draftedAnswers = questions.filter((q) => q.answers?.[0]?.status === \"DRAFT\").length;\n\n  let citationsCount = 0;\n  for (const q of questions) citationsCount += (q.answers?.[0]?.citations?.length ?? 0);\n\n  return { totalQuestions, answeredQuestions, approvedAnswers, draftedAnswers, citationsCount };\n}\n\nexport async function GET(req: Request, ctx: { params: Promise<{ projectId: string }> }) {\n  const { projectId } = await ctx.params;\n  const { searchParams } = new URL(req.url);\n  const formatRaw = (searchParams.get(\"format\") ?? \"csv\").toLowerCase();\n  const isJson = formatRaw === \"json\";\n  const formatEnum = isJson ? \"JSON\" : \"CSV\";\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    select: {\n      id: true,\n      name: true,\n      clientName: true,\n      type: true,\n      evidenceOnly: true,\n      updatedAt: true,\n    },\n  });\n\n  if (!project) {\n    return NextResponse.json({ error: \"Project not found\" }, { status: 404 });\n  }\n\n  const questions = await prisma.question.findMany({\n    where: { projectId },\n    orderBy: [{ number: \"asc\" }, { createdAt: \"asc\" }],\n    select: {\n      id: true,\n      number: true,\n      externalId: true,\n      section: true,\n      text: true,\n      answerType: true,\n      status: true,\n      confidence: true,\n      updatedAt: true,\n      answers: {\n        orderBy: [{ updatedAt: \"desc\" }],\n        take: 1,\n        select: {\n          id: true,\n          text: true,\n          status: true,\n          updatedAt: true,\n          citations: {\n            select: {\n              id: true,\n              snippet: true,\n              relevanceScore: true,\n              chunk: {\n                select: {\n                  sourceRef: true,\n                  document: { select: { title: true, filename: true } },\n                },\n              },\n            },\n          },\n        },\n      },\n    },\n  });\n\n  // Write an Export record (best-effort; do not fail export if logging fails)\n  try {\n    const stats = computeStats(questions);\n    const filePath = `ddq_${projectId}.${isJson ? \"json\" : \"csv\"}`;\n\n    await prisma.export.create({\n      data: {\n        projectId,\n        format: formatEnum as any,\n        filePath,\n        statsJson: JSON.stringify(stats),\n      },\n    });\n  } catch (e) {\n    // ignore\n  }\n\n  if (isJson) {\n    const payload = {\n      project,\n      exportedAt: new Date().toISOString(),\n      questions,\n    };\n\n    return new NextResponse(JSON.stringify(payload, null, 2), {\n      headers: {\n        \"Content-Type\": \"application/json; charset=utf-8\",\n        \"Content-Disposition\": `attachment; filename=\"ddq_${projectId}.json\"`,\n      },\n    });\n  }\n\n  const header = [\n    \"project_id\",\n    \"project_name\",\n    \"client_name\",\n    \"question_number\",\n    \"question_external_id\",\n    \"section\",\n    \"question_text\",\n    \"question_status\",\n    \"confidence\",\n    \"answer_status\",\n    \"answer_text\",\n    \"citations_count\",\n    \"citations\",\n    \"updated_at\",\n  ];\n\n  const rows: string[] = [];\n  rows.push(header.join(\",\"));\n\n  for (const q of questions) {\n    const a = q.answers?.[0] ?? null;\n\n    const citations = (a?.citations ?? []).map((c) => {\n      const docTitle = c.chunk?.document?.title ?? c.chunk?.document?.filename ?? \"doc\";\n      const ref = c.chunk?.sourceRef ?? \"\";\n      const score = typeof c.relevanceScore === \"number\" ? c.relevanceScore.toFixed(2) : \"\";\n      const snip = (c.snippet ?? \"\").slice(0, 180);\n      return `${docTitle} | ${ref} | score:${score} | ${snip}`;\n    });\n\n    const row = [\n      project.id,\n      project.name,\n      project.clientName ?? \"\",\n      q.number ?? \"\",\n      q.externalId ?? \"\",\n      q.section ?? \"\",\n      q.text,\n      q.status,\n      q.confidence,\n      a?.status ?? \"\",\n      a?.text ?? \"\",\n      String(citations.length),\n      citations.join(\" || \"),\n      new Date(q.updatedAt).toISOString(),\n    ].map(csvEscape);\n\n    rows.push(row.join(\",\"));\n  }\n\n  const csv = rows.join(\"\\n\");\n\n  return new NextResponse(csv, {\n    headers: {\n      \"Content-Type\": \"text/csv; charset=utf-8\",\n      \"Content-Disposition\": `attachment; filename=\"ddq_${projectId}.csv\"`,\n    },\n  });\n}\n"],"names":[],"mappings":"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"}}]
}