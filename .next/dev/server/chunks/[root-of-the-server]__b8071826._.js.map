{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/lib/db/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/lib/retrieval/rank.ts"],"sourcesContent":["export type RankedChunk = {\n  chunkId: string;\n  text: string;\n  sourceRef?: string | null;\n  documentTitle?: string | null;\n  filename?: string | null;\n  documentId: string;\n  score: number;\n};\n\nfunction tokenize(s: string): string[] {\n  return (s || \"\")\n    .toLowerCase()\n    .replace(/[^a-z0-9\\s]+/g, \" \")\n    .split(/\\s+/)\n    .filter((t) => t.length >= 3);\n}\n\nexport function scoreChunk(query: string, chunkText: string): number {\n  const q = tokenize(query);\n  const c = tokenize(chunkText);\n  if (q.length === 0 || c.length === 0) return 0;\n\n  const cFreq = new Map<string, number>();\n  for (const t of c) cFreq.set(t, (cFreq.get(t) ?? 0) + 1);\n\n  // Simple BM25-ish-ish scoring (not full BM25, but works well for MVP)\n  let score = 0;\n  const uniqueQ = Array.from(new Set(q));\n  for (const t of uniqueQ) {\n    const tf = cFreq.get(t) ?? 0;\n    if (tf === 0) continue;\n    score += 1 + Math.log(1 + tf);\n  }\n\n  // small length normalization\n  score = score / Math.sqrt(200 + c.length);\n\n  return score;\n}\n\nexport function pickBestSnippets(text: string, maxLen = 220): string {\n  const s = (text || \"\").trim().replace(/\\s+/g, \" \");\n  if (s.length <= maxLen) return s;\n  return s.slice(0, maxLen).trimEnd() + \"â€¦\";\n}\n"],"names":[],"mappings":";;;;;;AAUA,SAAS,SAAS,CAAS;IACzB,OAAO,CAAC,KAAK,EAAE,EACZ,WAAW,GACX,OAAO,CAAC,iBAAiB,KACzB,KAAK,CAAC,OACN,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,IAAI;AAC/B;AAEO,SAAS,WAAW,KAAa,EAAE,SAAiB;IACzD,MAAM,IAAI,SAAS;IACnB,MAAM,IAAI,SAAS;IACnB,IAAI,EAAE,MAAM,KAAK,KAAK,EAAE,MAAM,KAAK,GAAG,OAAO;IAE7C,MAAM,QAAQ,IAAI;IAClB,KAAK,MAAM,KAAK,EAAG,MAAM,GAAG,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC,MAAM,CAAC,IAAI;IAEtD,sEAAsE;IACtE,IAAI,QAAQ;IACZ,MAAM,UAAU,MAAM,IAAI,CAAC,IAAI,IAAI;IACnC,KAAK,MAAM,KAAK,QAAS;QACvB,MAAM,KAAK,MAAM,GAAG,CAAC,MAAM;QAC3B,IAAI,OAAO,GAAG;QACd,SAAS,IAAI,KAAK,GAAG,CAAC,IAAI;IAC5B;IAEA,6BAA6B;IAC7B,QAAQ,QAAQ,KAAK,IAAI,CAAC,MAAM,EAAE,MAAM;IAExC,OAAO;AACT;AAEO,SAAS,iBAAiB,IAAY,EAAE,SAAS,GAAG;IACzD,MAAM,IAAI,CAAC,QAAQ,EAAE,EAAE,IAAI,GAAG,OAAO,CAAC,QAAQ;IAC9C,IAAI,EAAE,MAAM,IAAI,QAAQ,OAAO;IAC/B,OAAO,EAAE,KAAK,CAAC,GAAG,QAAQ,OAAO,KAAK;AACxC"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/app/api/projects/%5BprojectId%5D/run/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/db/prisma\";\nimport { pickBestSnippets, scoreChunk } from \"@/lib/retrieval/rank\";\n\nexport const runtime = \"nodejs\";\n\ntype Body = {\n  topK?: number;\n  limit?: number;\n  includeDrafted?: boolean;\n};\n\nfunction clamp(n: number, min: number, max: number) {\n  return Math.min(Math.max(n, min), max);\n}\n\nasync function readBody(req: Request): Promise<Body> {\n  const ct = req.headers.get(\"content-type\") ?? \"\";\n  try {\n    if (ct.includes(\"application/json\")) return (await req.json()) as Body;\n    if (ct.includes(\"multipart/form-data\") || ct.includes(\"application/x-www-form-urlencoded\")) {\n      const fd = await req.formData();\n      const obj: Record<string, unknown> = {};\n      for (const [k, v] of fd.entries()) obj[k] = v;\n      return obj as Body;\n    }\n  } catch {\n    // ignore\n  }\n  return {};\n}\n\nasync function upsertAnswerByQuestionId(args: {\n  projectId: string;\n  questionId: string;\n  text: string;\n  status: \"DRAFT\";\n  createdBy: \"AGENT\";\n}) {\n  const existing = await prisma.answer.findFirst({\n    where: { questionId: args.questionId },\n    select: { id: true },\n  });\n\n  if (existing) {\n    return prisma.answer.update({\n      where: { id: existing.id },\n      data: { text: args.text, status: args.status },\n      select: { id: true, text: true, status: true, updatedAt: true },\n    });\n  }\n\n  return prisma.answer.create({\n    data: {\n      projectId: args.projectId,\n      questionId: args.questionId,\n      text: args.text,\n      status: args.status,\n      createdBy: args.createdBy,\n    },\n    select: { id: true, text: true, status: true, updatedAt: true },\n  });\n}\n\nexport async function POST(req: Request, ctx: { params: Promise<{ projectId: string }> }) {\n  const { projectId } = await ctx.params;\n\n  const body = await readBody(req);\n  const topK = clamp(Number(body.topK ?? 5), 1, 10);\n  const limit = clamp(Number(body.limit ?? 200), 1, 1000);\n  const includeDrafted = String(body.includeDrafted ?? \"false\") === \"true\";\n\n  const statuses: string[] = includeDrafted\n    ? [\"UNANSWERED\", \"GAP\", \"NEEDS_REVIEW\", \"DRAFTED\"]\n    : [\"UNANSWERED\", \"GAP\", \"NEEDS_REVIEW\"];\n\n  const questions = await prisma.question.findMany({\n    where: { projectId, status: { in: statuses } },\n    orderBy: [{ number: \"asc\" }, { createdAt: \"asc\" }],\n    take: limit,\n    select: { id: true, projectId: true, text: true, status: true },\n  });\n\n  const chunks = await prisma.documentChunk.findMany({\n    where: { projectId },\n    select: {\n      id: true,\n      text: true,\n      sourceRef: true,\n      documentId: true,\n      document: { select: { title: true, filename: true } },\n    },\n    take: 3000, // MVP safety cap\n  });\n\n  const errors: Array<{ questionId: string; error: string }> = [];\n  let drafted = 0;\n  let gaps = 0;\n\n  for (const q of questions) {\n    try {\n      const ranked = chunks\n        .map((c) => {\n          const score = scoreChunk(q.text, c.text);\n          return {\n            chunkId: c.id,\n            text: c.text,\n            sourceRef: c.sourceRef,\n            documentId: c.documentId,\n            documentTitle: c.document?.title ?? null,\n            filename: c.document?.filename ?? null,\n            score,\n          };\n        })\n        .filter((r) => r.score > 0)\n        .sort((a, b) => b.score - a.score)\n        .slice(0, topK);\n\n      if (ranked.length === 0) {\n        const answer = await upsertAnswerByQuestionId({\n          projectId: q.projectId,\n          questionId: q.id,\n          text: \"I couldn't find supporting evidence in the Knowledge Base yet. Upload relevant policy docs and try again.\",\n          status: \"DRAFT\",\n          createdBy: \"AGENT\",\n        });\n\n        await prisma.citation.deleteMany({ where: { answerId: answer.id } });\n        await prisma.question.update({ where: { id: q.id }, data: { status: \"GAP\" } });\n\n        gaps += 1;\n        continue;\n      }\n\n      const bullets = ranked.map((r, i) => {\n        const doc = r.documentTitle ?? r.filename ?? \"Document\";\n        const ref = r.sourceRef ? ` (${r.sourceRef})` : \"\";\n        return `- Evidence ${i + 1}: ${doc}${ref}`;\n      });\n\n      const draftText =\n`Based on the uploaded documentation, here is the current evidence:\n\n${bullets.join(\"\\n\")}\n\nDraft response (edit as needed):\n[Write a concise, audit-friendly answer here referencing the evidence above.]`;\n\n      const answer = await upsertAnswerByQuestionId({\n        projectId: q.projectId,\n        questionId: q.id,\n        text: draftText,\n        status: \"DRAFT\",\n        createdBy: \"AGENT\",\n      });\n\n      await prisma.citation.deleteMany({ where: { answerId: answer.id } });\n      await prisma.citation.createMany({\n        data: ranked.map((r) => ({\n          answerId: answer.id,\n          chunkId: r.chunkId,\n          snippet: pickBestSnippets(r.text, 220),\n          relevanceScore: r.score,\n          startOffset: null,\n          endOffset: null,\n        })),\n      });\n\n      await prisma.question.update({ where: { id: q.id }, data: { status: \"DRAFTED\" } });\n\n      drafted += 1;\n    } catch (e: any) {\n      errors.push({ questionId: q.id, error: e?.message ?? String(e) });\n    }\n  }\n\n  return NextResponse.json({\n    ok: true,\n    projectId,\n    processed: questions.length,\n    drafted,\n    gaps,\n    errors,\n  });\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEO,MAAM,UAAU;AAQvB,SAAS,MAAM,CAAS,EAAE,GAAW,EAAE,GAAW;IAChD,OAAO,KAAK,GAAG,CAAC,KAAK,GAAG,CAAC,GAAG,MAAM;AACpC;AAEA,eAAe,SAAS,GAAY;IAClC,MAAM,KAAK,IAAI,OAAO,CAAC,GAAG,CAAC,mBAAmB;IAC9C,IAAI;QACF,IAAI,GAAG,QAAQ,CAAC,qBAAqB,OAAQ,MAAM,IAAI,IAAI;QAC3D,IAAI,GAAG,QAAQ,CAAC,0BAA0B,GAAG,QAAQ,CAAC,sCAAsC;YAC1F,MAAM,KAAK,MAAM,IAAI,QAAQ;YAC7B,MAAM,MAA+B,CAAC;YACtC,KAAK,MAAM,CAAC,GAAG,EAAE,IAAI,GAAG,OAAO,GAAI,GAAG,CAAC,EAAE,GAAG;YAC5C,OAAO;QACT;IACF,EAAE,OAAM;IACN,SAAS;IACX;IACA,OAAO,CAAC;AACV;AAEA,eAAe,yBAAyB,IAMvC;IACC,MAAM,WAAW,MAAM,sIAAM,CAAC,MAAM,CAAC,SAAS,CAAC;QAC7C,OAAO;YAAE,YAAY,KAAK,UAAU;QAAC;QACrC,QAAQ;YAAE,IAAI;QAAK;IACrB;IAEA,IAAI,UAAU;QACZ,OAAO,sIAAM,CAAC,MAAM,CAAC,MAAM,CAAC;YAC1B,OAAO;gBAAE,IAAI,SAAS,EAAE;YAAC;YACzB,MAAM;gBAAE,MAAM,KAAK,IAAI;gBAAE,QAAQ,KAAK,MAAM;YAAC;YAC7C,QAAQ;gBAAE,IAAI;gBAAM,MAAM;gBAAM,QAAQ;gBAAM,WAAW;YAAK;QAChE;IACF;IAEA,OAAO,sIAAM,CAAC,MAAM,CAAC,MAAM,CAAC;QAC1B,MAAM;YACJ,WAAW,KAAK,SAAS;YACzB,YAAY,KAAK,UAAU;YAC3B,MAAM,KAAK,IAAI;YACf,QAAQ,KAAK,MAAM;YACnB,WAAW,KAAK,SAAS;QAC3B;QACA,QAAQ;YAAE,IAAI;YAAM,MAAM;YAAM,QAAQ;YAAM,WAAW;QAAK;IAChE;AACF;AAEO,eAAe,KAAK,GAAY,EAAE,GAA+C;IACtF,MAAM,EAAE,SAAS,EAAE,GAAG,MAAM,IAAI,MAAM;IAEtC,MAAM,OAAO,MAAM,SAAS;IAC5B,MAAM,OAAO,MAAM,OAAO,KAAK,IAAI,IAAI,IAAI,GAAG;IAC9C,MAAM,QAAQ,MAAM,OAAO,KAAK,KAAK,IAAI,MAAM,GAAG;IAClD,MAAM,iBAAiB,OAAO,KAAK,cAAc,IAAI,aAAa;IAElE,MAAM,WAAqB,iBACvB;QAAC;QAAc;QAAO;QAAgB;KAAU,GAChD;QAAC;QAAc;QAAO;KAAe;IAEzC,MAAM,YAAY,MAAM,sIAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC;QAC/C,OAAO;YAAE;YAAW,QAAQ;gBAAE,IAAI;YAAS;QAAE;QAC7C,SAAS;YAAC;gBAAE,QAAQ;YAAM;YAAG;gBAAE,WAAW;YAAM;SAAE;QAClD,MAAM;QACN,QAAQ;YAAE,IAAI;YAAM,WAAW;YAAM,MAAM;YAAM,QAAQ;QAAK;IAChE;IAEA,MAAM,SAAS,MAAM,sIAAM,CAAC,aAAa,CAAC,QAAQ,CAAC;QACjD,OAAO;YAAE;QAAU;QACnB,QAAQ;YACN,IAAI;YACJ,MAAM;YACN,WAAW;YACX,YAAY;YACZ,UAAU;gBAAE,QAAQ;oBAAE,OAAO;oBAAM,UAAU;gBAAK;YAAE;QACtD;QACA,MAAM;IACR;IAEA,MAAM,SAAuD,EAAE;IAC/D,IAAI,UAAU;IACd,IAAI,OAAO;IAEX,KAAK,MAAM,KAAK,UAAW;QACzB,IAAI;YACF,MAAM,SAAS,OACZ,GAAG,CAAC,CAAC;gBACJ,MAAM,QAAQ,IAAA,+IAAU,EAAC,EAAE,IAAI,EAAE,EAAE,IAAI;gBACvC,OAAO;oBACL,SAAS,EAAE,EAAE;oBACb,MAAM,EAAE,IAAI;oBACZ,WAAW,EAAE,SAAS;oBACtB,YAAY,EAAE,UAAU;oBACxB,eAAe,EAAE,QAAQ,EAAE,SAAS;oBACpC,UAAU,EAAE,QAAQ,EAAE,YAAY;oBAClC;gBACF;YACF,GACC,MAAM,CAAC,CAAC,IAAM,EAAE,KAAK,GAAG,GACxB,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK,EAChC,KAAK,CAAC,GAAG;YAEZ,IAAI,OAAO,MAAM,KAAK,GAAG;gBACvB,MAAM,SAAS,MAAM,yBAAyB;oBAC5C,WAAW,EAAE,SAAS;oBACtB,YAAY,EAAE,EAAE;oBAChB,MAAM;oBACN,QAAQ;oBACR,WAAW;gBACb;gBAEA,MAAM,sIAAM,CAAC,QAAQ,CAAC,UAAU,CAAC;oBAAE,OAAO;wBAAE,UAAU,OAAO,EAAE;oBAAC;gBAAE;gBAClE,MAAM,sIAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;oBAAE,OAAO;wBAAE,IAAI,EAAE,EAAE;oBAAC;oBAAG,MAAM;wBAAE,QAAQ;oBAAM;gBAAE;gBAE5E,QAAQ;gBACR;YACF;YAEA,MAAM,UAAU,OAAO,GAAG,CAAC,CAAC,GAAG;gBAC7B,MAAM,MAAM,EAAE,aAAa,IAAI,EAAE,QAAQ,IAAI;gBAC7C,MAAM,MAAM,EAAE,SAAS,GAAG,CAAC,EAAE,EAAE,EAAE,SAAS,CAAC,CAAC,CAAC,GAAG;gBAChD,OAAO,CAAC,WAAW,EAAE,IAAI,EAAE,EAAE,EAAE,MAAM,KAAK;YAC5C;YAEA,MAAM,YACZ,CAAC;;AAED,EAAE,QAAQ,IAAI,CAAC,MAAM;;;6EAGwD,CAAC;YAExE,MAAM,SAAS,MAAM,yBAAyB;gBAC5C,WAAW,EAAE,SAAS;gBACtB,YAAY,EAAE,EAAE;gBAChB,MAAM;gBACN,QAAQ;gBACR,WAAW;YACb;YAEA,MAAM,sIAAM,CAAC,QAAQ,CAAC,UAAU,CAAC;gBAAE,OAAO;oBAAE,UAAU,OAAO,EAAE;gBAAC;YAAE;YAClE,MAAM,sIAAM,CAAC,QAAQ,CAAC,UAAU,CAAC;gBAC/B,MAAM,OAAO,GAAG,CAAC,CAAC,IAAM,CAAC;wBACvB,UAAU,OAAO,EAAE;wBACnB,SAAS,EAAE,OAAO;wBAClB,SAAS,IAAA,qJAAgB,EAAC,EAAE,IAAI,EAAE;wBAClC,gBAAgB,EAAE,KAAK;wBACvB,aAAa;wBACb,WAAW;oBACb,CAAC;YACH;YAEA,MAAM,sIAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;gBAAE,OAAO;oBAAE,IAAI,EAAE,EAAE;gBAAC;gBAAG,MAAM;oBAAE,QAAQ;gBAAU;YAAE;YAEhF,WAAW;QACb,EAAE,OAAO,GAAQ;YACf,OAAO,IAAI,CAAC;gBAAE,YAAY,EAAE,EAAE;gBAAE,OAAO,GAAG,WAAW,OAAO;YAAG;QACjE;IACF;IAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;QACvB,IAAI;QACJ;QACA,WAAW,UAAU,MAAM;QAC3B;QACA;QACA;IACF;AACF"}}]
}