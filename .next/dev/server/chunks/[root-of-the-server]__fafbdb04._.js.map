{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/lib/db/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/lib/kb/chunk.ts"],"sourcesContent":["export type Chunk = {\n  chunkIndex: number;\n  text: string;\n  tokenCount?: number;\n  sourceRef?: string;\n};\n\nexport function chunkText(\n  input: string,\n  opts?: { maxChars?: number; overlapChars?: number; sourceRef?: string }\n): Chunk[] {\n  const maxChars = opts?.maxChars ?? 1200;\n  const overlapChars = opts?.overlapChars ?? 200;\n  const sourceRef = opts?.sourceRef;\n\n  const text = (input ?? \"\").replace(/\\r\\n/g, \"\\n\").trim();\n  if (!text) return [];\n\n  const chunks: Chunk[] = [];\n  let i = 0;\n  let idx = 0;\n\n  while (i < text.length) {\n    const end = Math.min(i + maxChars, text.length);\n    const slice = text.slice(i, end).trim();\n    if (slice) {\n      chunks.push({\n        chunkIndex: idx++,\n        text: slice,\n        tokenCount: Math.ceil(slice.length / 4),\n        sourceRef,\n      });\n    }\n    if (end >= text.length) break;\n    i = Math.max(0, end - overlapChars);\n  }\n\n  return chunks;\n}\n"],"names":[],"mappings":";;;;AAOO,SAAS,UACd,KAAa,EACb,IAAuE;IAEvE,MAAM,WAAW,MAAM,YAAY;IACnC,MAAM,eAAe,MAAM,gBAAgB;IAC3C,MAAM,YAAY,MAAM;IAExB,MAAM,OAAO,CAAC,SAAS,EAAE,EAAE,OAAO,CAAC,SAAS,MAAM,IAAI;IACtD,IAAI,CAAC,MAAM,OAAO,EAAE;IAEpB,MAAM,SAAkB,EAAE;IAC1B,IAAI,IAAI;IACR,IAAI,MAAM;IAEV,MAAO,IAAI,KAAK,MAAM,CAAE;QACtB,MAAM,MAAM,KAAK,GAAG,CAAC,IAAI,UAAU,KAAK,MAAM;QAC9C,MAAM,QAAQ,KAAK,KAAK,CAAC,GAAG,KAAK,IAAI;QACrC,IAAI,OAAO;YACT,OAAO,IAAI,CAAC;gBACV,YAAY;gBACZ,MAAM;gBACN,YAAY,KAAK,IAAI,CAAC,MAAM,MAAM,GAAG;gBACrC;YACF;QACF;QACA,IAAI,OAAO,KAAK,MAAM,EAAE;QACxB,IAAI,KAAK,GAAG,CAAC,GAAG,MAAM;IACxB;IAEA,OAAO;AACT"}},
    {"offset": {"line": 109, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/app/api/projects/%5BprojectId%5D/kb/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/db/prisma\";\nimport { chunkText } from \"@/lib/kb/chunk\";\nimport path from \"path\";\nimport fs from \"fs/promises\";\n\nexport const runtime = \"nodejs\";\n\nfunction safeName(name: string) {\n  return name.replace(/[^\\w.\\-() ]+/g, \"_\").slice(0, 120);\n}\n\nfunction isTextLike(mime: string | null) {\n  if (!mime) return false;\n  return (\n    mime.startsWith(\"text/\") ||\n    mime === \"application/json\" ||\n    mime === \"application/xml\"\n  );\n}\n\nexport async function GET(\n  _req: Request,\n  ctx: { params: Promise<{ projectId: string }> }\n) {\n  const { projectId } = await ctx.params;\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    select: { id: true, name: true },\n  });\n\n  if (!project) {\n    return NextResponse.json({ error: \"Project not found\" }, { status: 404 });\n  }\n\n  const docs = await prisma.knowledgeDocument.findMany({\n    where: { projectId },\n    orderBy: { uploadedAt: \"desc\" },\n    select: {\n      id: true,\n      title: true,\n      filename: true,\n      mimeType: true,\n      storagePath: true,\n      sha256: true,\n      uploadedAt: true,\n      _count: { select: { chunks: true } },\n    },\n  });\n\n  return NextResponse.json({ project, docs });\n}\n\nexport async function POST(\n  req: Request,\n  ctx: { params: Promise<{ projectId: string }> }\n) {\n  const { projectId } = await ctx.params;\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    select: { id: true },\n  });\n\n  if (!project) {\n    return NextResponse.json({ error: \"Project not found\" }, { status: 404 });\n  }\n\n  const form = await req.formData();\n  const file = form.get(\"file\") as File | null;\n  const title = (form.get(\"title\") as string | null) ?? null;\n\n  if (!file) {\n    return NextResponse.json({ error: \"Missing file\" }, { status: 400 });\n  }\n\n  const filename = safeName(file.name || \"document.txt\");\n  const mimeType = file.type || \"application/octet-stream\";\n\n  // Save file to local disk (MVP storage)\n  const dir = path.join(process.cwd(), \"storage\", projectId);\n  await fs.mkdir(dir, { recursive: true });\n  const storagePath = path.join(\"storage\", projectId, `${Date.now()}_${filename}`);\n  const absPath = path.join(process.cwd(), storagePath);\n\n  const buf = Buffer.from(await file.arrayBuffer());\n  await fs.writeFile(absPath, buf);\n\n  // Create doc row\n  const doc = await prisma.knowledgeDocument.create({\n    data: {\n      projectId,\n      title,\n      filename,\n      mimeType,\n      storagePath,\n      sha256: null,\n    },\n    select: { id: true, filename: true, mimeType: true, storagePath: true, uploadedAt: true },\n  });\n\n  // Text-only chunking for MVP\n  let chunkCount = 0;\n  let warning: string | null = null;\n\n  if (isTextLike(mimeType)) {\n    const text = buf.toString(\"utf8\");\n    const chunks = chunkText(text, {\n      maxChars: 1200,\n      overlapChars: 200,\n      sourceRef: `${filename}`,\n    });\n\n    if (chunks.length) {\n      await prisma.documentChunk.createMany({\n        data: chunks.map((c) => ({\n          projectId,\n          documentId: doc.id,\n          chunkIndex: c.chunkIndex,\n          text: c.text,\n          sourceRef: c.sourceRef,\n          tokenCount: c.tokenCount,\n        })),\n      });\n      chunkCount = chunks.length;\n    }\n  } else {\n    warning =\n      \"Uploaded successfully, but chunking is enabled only for text-like files in this MVP (txt/md/json).\";\n  }\n\n  return NextResponse.json({\n    ok: true,\n    doc,\n    chunkCount,\n    warning,\n  });\n}\n"],"names":[],"mappings":"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"}}]
}