{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/lib/db/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/lib/retrieval/rank.ts"],"sourcesContent":["export type RankedChunk = {\n  chunkId: string;\n  text: string;\n  sourceRef?: string | null;\n  documentTitle?: string | null;\n  filename?: string | null;\n  documentId: string;\n  score: number;\n};\n\nfunction tokenize(s: string): string[] {\n  return (s || \"\")\n    .toLowerCase()\n    .replace(/[^a-z0-9\\s]+/g, \" \")\n    .split(/\\s+/)\n    .filter((t) => t.length >= 3);\n}\n\nexport function scoreChunk(query: string, chunkText: string): number {\n  const q = tokenize(query);\n  const c = tokenize(chunkText);\n  if (q.length === 0 || c.length === 0) return 0;\n\n  const cFreq = new Map<string, number>();\n  for (const t of c) cFreq.set(t, (cFreq.get(t) ?? 0) + 1);\n\n  // Simple BM25-ish-ish scoring (not full BM25, but works well for MVP)\n  let score = 0;\n  const uniqueQ = Array.from(new Set(q));\n  for (const t of uniqueQ) {\n    const tf = cFreq.get(t) ?? 0;\n    if (tf === 0) continue;\n    score += 1 + Math.log(1 + tf);\n  }\n\n  // small length normalization\n  score = score / Math.sqrt(200 + c.length);\n\n  return score;\n}\n\nexport function pickBestSnippets(text: string, maxLen = 220): string {\n  const s = (text || \"\").trim().replace(/\\s+/g, \" \");\n  if (s.length <= maxLen) return s;\n  return s.slice(0, maxLen).trimEnd() + \"â€¦\";\n}\n"],"names":[],"mappings":";;;;;;AAUA,SAAS,SAAS,CAAS;IACzB,OAAO,CAAC,KAAK,EAAE,EACZ,WAAW,GACX,OAAO,CAAC,iBAAiB,KACzB,KAAK,CAAC,OACN,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,IAAI;AAC/B;AAEO,SAAS,WAAW,KAAa,EAAE,SAAiB;IACzD,MAAM,IAAI,SAAS;IACnB,MAAM,IAAI,SAAS;IACnB,IAAI,EAAE,MAAM,KAAK,KAAK,EAAE,MAAM,KAAK,GAAG,OAAO;IAE7C,MAAM,QAAQ,IAAI;IAClB,KAAK,MAAM,KAAK,EAAG,MAAM,GAAG,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC,MAAM,CAAC,IAAI;IAEtD,sEAAsE;IACtE,IAAI,QAAQ;IACZ,MAAM,UAAU,MAAM,IAAI,CAAC,IAAI,IAAI;IACnC,KAAK,MAAM,KAAK,QAAS;QACvB,MAAM,KAAK,MAAM,GAAG,CAAC,MAAM;QAC3B,IAAI,OAAO,GAAG;QACd,SAAS,IAAI,KAAK,GAAG,CAAC,IAAI;IAC5B;IAEA,6BAA6B;IAC7B,QAAQ,QAAQ,KAAK,IAAI,CAAC,MAAM,EAAE,MAAM;IAExC,OAAO;AACT;AAEO,SAAS,iBAAiB,IAAY,EAAE,SAAS,GAAG;IACzD,MAAM,IAAI,CAAC,QAAQ,EAAE,EAAE,IAAI,GAAG,OAAO,CAAC,QAAQ;IAC9C,IAAI,EAAE,MAAM,IAAI,QAAQ,OAAO;IAC/B,OAAO,EAAE,KAAK,CAAC,GAAG,QAAQ,OAAO,KAAK;AACxC"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///Users/yersultanakhmer/Desktop/AIHackathon/ddq-copilot/src/app/api/questions/%5BquestionId%5D/draft/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/db/prisma\";\nimport { pickBestSnippets, scoreChunk } from \"@/lib/retrieval/rank\";\n\nexport const runtime = \"nodejs\";\n\ntype Body = { topK?: number };\n\nasync function upsertAnswerByQuestionId(args: {\n  projectId: string;\n  questionId: string;\n  text: string;\n  status: \"DRAFT\";\n  createdBy: \"AGENT\";\n}) {\n  const existing = await prisma.answer.findFirst({\n    where: { questionId: args.questionId },\n    orderBy: { updatedAt: \"desc\" },\n    select: { id: true },\n  });\n\n  if (existing) {\n    return prisma.answer.update({\n      where: { id: existing.id },\n      data: { text: args.text, status: args.status },\n      select: { id: true, text: true, status: true, updatedAt: true },\n    });\n  }\n\n  return prisma.answer.create({\n    data: {\n      projectId: args.projectId,\n      questionId: args.questionId,\n      text: args.text,\n      status: args.status,\n      createdBy: args.createdBy,\n    },\n    select: { id: true, text: true, status: true, updatedAt: true },\n  });\n}\n\nexport async function POST(req: Request, ctx: { params: Promise<{ questionId: string }> }) {\n  const { questionId } = await ctx.params;\n\n  const body = (await req.json().catch(() => ({}))) as Body;\n  const topK = Math.min(Math.max(body.topK ?? 5, 1), 10);\n\n  const q = await prisma.question.findUnique({\n    where: { id: questionId },\n    select: { id: true, projectId: true, text: true },\n  });\n\n  if (!q) return NextResponse.json({ error: \"Question not found\" }, { status: 404 });\n\n  const chunks = await prisma.documentChunk.findMany({\n    where: { projectId: q.projectId },\n    select: {\n      id: true,\n      text: true,\n      sourceRef: true,\n      documentId: true,\n      document: { select: { title: true, filename: true } },\n    },\n    take: 3000,\n  });\n\n  const ranked = chunks\n    .map((c) => ({\n      chunkId: c.id,\n      text: c.text,\n      sourceRef: c.sourceRef,\n      documentId: c.documentId,\n      documentTitle: c.document?.title ?? null,\n      filename: c.document?.filename ?? null,\n      score: scoreChunk(q.text, c.text),\n    }))\n    .filter((r) => r.score > 0)\n    .sort((a, b) => b.score - a.score)\n    .slice(0, topK);\n\n  if (ranked.length === 0) {\n    const text =\n      \"I couldn't find supporting evidence in the Knowledge Base yet. Upload relevant policy docs and try again.\";\n\n    const answer = await upsertAnswerByQuestionId({\n      projectId: q.projectId,\n      questionId: q.id,\n      text,\n      status: \"DRAFT\",\n      createdBy: \"AGENT\",\n    });\n\n    await prisma.question.update({ where: { id: q.id }, data: { status: \"GAP\" } });\n    await prisma.citation.deleteMany({ where: { answerId: answer.id } });\n\n    return NextResponse.json({ ok: true, answer, evidence: [], note: \"No relevant chunks found. Marked question as GAP.\" });\n  }\n\n  const bullets = ranked.map((r, i) => {\n    const doc = r.documentTitle ?? r.filename ?? \"Document\";\n    const ref = r.sourceRef ? ` (${r.sourceRef})` : \"\";\n    return `- Evidence ${i + 1}: ${doc}${ref}`;\n  });\n\n  const draftText = `Based on the uploaded documentation, here is the current evidence:\n\n${bullets.join(\"\\n\")}\n\nDraft response (edit as needed):\n[Write a concise, audit-friendly answer here referencing the evidence above.]`;\n\n  const answer = await upsertAnswerByQuestionId({\n    projectId: q.projectId,\n    questionId: q.id,\n    text: draftText,\n    status: \"DRAFT\",\n    createdBy: \"AGENT\",\n  });\n\n  await prisma.citation.deleteMany({ where: { answerId: answer.id } });\n\n  await prisma.citation.createMany({\n    data: ranked.map((r) => ({\n      answerId: answer.id,\n      chunkId: r.chunkId,\n      snippet: pickBestSnippets(r.text, 220),\n      relevanceScore: r.score,\n      startOffset: null,\n      endOffset: null,\n    })),\n  });\n\n  await prisma.question.update({ where: { id: q.id }, data: { status: \"DRAFTED\" } });\n\n  const evidence = ranked.map((r) => ({\n    chunkId: r.chunkId,\n    snippet: pickBestSnippets(r.text, 220),\n    relevanceScore: r.score,\n    sourceRef: r.sourceRef,\n    documentId: r.documentId,\n    documentTitle: r.documentTitle,\n    filename: r.filename,\n  }));\n\n  return NextResponse.json({ ok: true, answer, evidence });\n}\n"],"names":[],"mappings":"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"}}]
}